---
- name: Create or update prometheus config directory.
  become: true
  ansible.builtin.file:
    path: "{{ appdata_path }}/{{ item.name }}/config"
    state: directory
    owner: "{{ path_file_owner }}"
    group: "{{ path_file_group }}"
    mode: "{{ path_mode }}"

- name: Create or update prometheus data directory.
  become: true
  ansible.builtin.file:
    path: "{{ appdata_path }}/{{ item.name }}/data"
    state: directory
    owner: "{{ path_file_owner }}"
    group: "{{ path_file_group }}"
    mode: "{{ path_mode }}"

- name: Generate or update prometheus config.
  become: true
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ appdata_path }}/{{ item.name }}/config/prometheus.yml"
    owner: "{{ path_file_owner }}"
    group: "{{ path_file_group }}"
    mode: "{{ file_mode }}"
  notify: Restart prometheus

- name: Generate or update prometheus alert rules.
  become: true
  ansible.builtin.copy:
    src: alert.rules
    dest: "{{ appdata_path }}/{{ item.name }}/config/alert.rules"
    owner: "{{ path_file_owner }}"
    group: "{{ path_file_group }}"
    mode: "{{ file_mode }}"
  notify: Restart prometheus
